---
layout: post
title: "树剖"
date: 2026-03-01
categories: [理论,算法]
author: _endl_
---

首先引入重边的概念：对于节点u，他的所有儿子中，sz最大的v，与u连结的边称为重边，其他的都称为轻边。然后由重边组成的链叫重链。

每一个重链互不相交覆盖所有节点。

## 然后你可以用这个算lca:

维护sz,fa,son,dep,再加上一个tp，$tp_u$表示u节点所在重链的链头。

前边几个好维护，主要是tp。

第二次DFS的时候，先处理重儿子，和自己是一个链头。然后轻儿子链头就是他自己。

然后你维护好tp了，可以算lca。就是u,v两个点，你一直找他俩更深的，然后让他直接跳到链头。最后如果u,v在一条链里，那他俩lca就是浅的那个。

复杂度是log。

因为考虑如果是重链，那么直接跳过去，所以真正决定复杂度的是轻链数量，考虑最劣情况：u到v全为轻链，那为了保证左边是重链，v的左边应该为1个，$fa_v$左边是3个，以此类推。不难看出这就是满二叉树，层数就是log。

这个跑上去会比倍增常数小一些。

## 与线段树

你给他打一个dfn，因为你一个重链里边dfn一定是连续的，然后可以变成序列操作。模板就是u到v这个链加k，然后查u到v这个链的和[P3384 【模板】重链剖分 / 树链剖分
](https://www.luogu.com.cn/problem/P3384)，对于子树操作，考虑一个子树dfn是连续的，直接对dfn[u]到dfn[u]+sz[u]-1做修改即可。
